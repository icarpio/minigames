<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Puzzle 4x4 con Mezcla en CuadrÃ­cula</title>
  <style>
    body {
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 20px;
    }
    #puzzle {
      margin-top: 50px;
      width: 600px;
      height: 600px;
    }
    #puzzle canvas {
  background-color: #e0e0e0 !important;
}
  </style>
</head>
<body>
  <h1>Rompecabezas</h1>
  <div id="puzzle"></div>

  <!-- LibrerÃ­a headbreaker -->
  <script src="https://flbulgarelli.github.io/headbreaker/js/headbreaker.js"></script>
  <script type="module">
     import { saveGameSession } from '../js/api.js';

    const token = (localStorage.getItem('token') || '').trim();
    if (!token) {
      alert('No has iniciado sesiÃ³n. SerÃ¡s redirigido al login.');
      window.location.href = '../index.html';
    }
    const images = [
      '../assets/img/01.jpg',
      '../assets/img/02.jpg',
      '../assets/img/03.jpg',
      '../assets/img/04.jpg',
      '../assets/img/05.jpg',
      '../assets/img/06.jpg',
      '../assets/img/07.jpg',
      '../assets/img/08.jpg',
    ];

    const randomImageSrc = images[Math.floor(Math.random() * images.length)];
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.src = randomImageSrc;

    img.onload = () => {
      const container = document.getElementById('puzzle');
      container.innerHTML = '';

      const puzzle = new headbreaker.Canvas('puzzle', {
        width: 600,
        height: 600,
        pieceSize: 60,
        image: img,
        strokeWidth: 2.5,
        strokeColor: '#F0F0F0',
        outline: new headbreaker.outline.Rounded()
      });

      puzzle.adjustImagesToPuzzleWidth();

      puzzle.autogenerate({
        horizontalPiecesCount: 6,
        verticalPiecesCount: 6,
        insertsGenerator: headbreaker.generators.random
      });

      puzzle.shuffle();
	    puzzle.shuffleGrid();

      // ðŸŽ¨ MODIFICAR EL COLOR DEL BACKGROUND
      const canvas = document.querySelector('#puzzle canvas');
      const ctx = canvas.getContext('2d');

      // Pinta el fondo ANTES de dibujar las piezas
      ctx.fillStyle = '#e0e0e0'; // Cambia a cualquier color que quieras
      ctx.fillRect(0, 0, canvas.width, canvas.height);
	  //puzzle.shuffleColumns();
      puzzle.draw();

      puzzle.registerKeyboardGestures();

        function getScore() {
        return isSolved() ? 2000 : 0;
      }

      async function saveScore() {
      const points = getScore(); // Usa isSolved() internamente
      try {
        await saveGameSession(token, 'RompeCabezas', points);
        console.log(`Puntos guardados: ${points}`);
      } catch (e) {
        alert('Error guardando puntuaciÃ³n: ' + e.message);
        if (e.message.toLowerCase().includes('unauthorized')) {
          localStorage.clear();
          window.location.href = '../index.html';
        }
      }
    }
      function checkSolved() {
        if (puzzle.isSolved && puzzle.isSolved()) {
          alert('ðŸŽ‰ Â¡Puzzle completado! Has ganado 2000 puntos!');
        } else {
          setTimeout(checkSolved, 1000);
        }
      }
      checkSolved();
    };
  </script>
</body>
</html>

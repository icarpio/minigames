<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>RompeCabezas</title>
  <style>
    body {
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 20px;
    }
    #puzzle {
      margin-top: 50px;
      margin-left: 130px;
      width: 600px;
      height: 600px;
    }
    #puzzle canvas {
      background-color: #e0e0e0 !important;
    }
    #reference {
      margin-top: 5px;
      max-width: 264px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <h1>Rompecabezas</h1>
  <div id="puzzle"></div>
  <img id="reference" alt="Imagen de referencia">

  <!-- LibrerÃ­a headbreaker -->
  <script src="https://flbulgarelli.github.io/headbreaker/js/headbreaker.js"></script>
  <script type="module">
    import { saveGameSession } from '../js/api.js';

    const token = (localStorage.getItem('token') || '').trim();
    if (!token) {
      alert('No has iniciado sesiÃ³n. SerÃ¡s redirigido al login.');
      window.location.href = '../index.html';
    }

    const images = [
      '../assets/img/01.jpg',
      '../assets/img/02.jpg',
      '../assets/img/03.jpg',
      '../assets/img/04.jpg',
      '../assets/img/05.jpg',
      '../assets/img/06.jpg',
      '../assets/img/07.jpg',
      '../assets/img/08.jpg',
    ];

    const randomImageSrc = images[Math.floor(Math.random() * images.length)];
    document.getElementById('reference').src = randomImageSrc; // Muestra la imagen de referencia

    const img = new Image();
    img.crossOrigin = "anonymous";
    img.src = randomImageSrc;

    img.onload = () => {
      const container = document.getElementById('puzzle');
      container.innerHTML = '';

      const puzzle = new headbreaker.Canvas('puzzle', {
        width: 480,
        height: 480,
        pieceSize: 60,
        image: img,
        strokeWidth: 2.5,
        strokeColor: '#F0F0F0',
        outline: new headbreaker.outline.Rounded()
      });

      puzzle.adjustImagesToPuzzleWidth();

      puzzle.autogenerate({
        horizontalPiecesCount: 5,
        verticalPiecesCount: 5,
        insertsGenerator: headbreaker.generators.random
      });

      puzzle.shuffle();
      puzzle.shuffleGrid();

      const canvas = document.querySelector('#puzzle canvas');
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#e0e0e0';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      puzzle.draw();
      puzzle.registerKeyboardGestures();

      function getScore() {
        return isSolved() ? 2000 : 0;
      }

      async function saveScore() {
        const points = getScore();
        try {
          await saveGameSession(token, 'RompeCabezas', points);
          console.log(`Puntos guardados: ${points}`);
        } catch (e) {
          alert('Error guardando puntuaciÃ³n: ' + e.message);
          if (e.message.toLowerCase().includes('unauthorized')) {
            localStorage.clear();
            window.location.href = '../index.html';
          }
        }
      }

      function checkSolved() {
        if (puzzle.isSolved && puzzle.isSolved()) {
          alert('ðŸŽ‰ Â¡Puzzle completado! Has ganado 2000 puntos!');
          saveScore();
        } else {
          setTimeout(checkSolved, 1000);
        }
      }

      checkSolved();
    };
  </script>
</body>
</html>

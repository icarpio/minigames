<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Puzzle 4x4 con Mezcla en Cuadr铆cula</title>
  <style>
    body {
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 20px;
    }
    #puzzle {
      margin-top: 50px;
      width: 600px;
      height: 600px;
    }
    #puzzle canvas {
      background-color: #e0e0e0 !important;
    }
    #score {
      margin-top: 20px;
      font-size: 24px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Rompecabezas</h1>
  <div id="puzzle"></div>
  <div id="score">Puntuaci贸n: 0</div>

  <!-- Librer铆a headbreaker -->
  <script src="https://flbulgarelli.github.io/headbreaker/js/headbreaker.js"></script>

  <!-- Script para el puzzle y puntuaci贸n -->
  <script>
    // Funci贸n para simular import de saveGameSession (ajusta seg煤n tu proyecto real)
    async function saveGameSession(token, gameName, points) {
      // Aqu铆 ir铆a la llamada real a tu API para guardar la puntuaci贸n
      // Simulaci贸n:
      return new Promise((resolve) => {
        console.log(`Guardando juego: ${gameName} con puntos: ${points} y token: ${token}`);
        setTimeout(resolve, 1000);
      });
    }

    const token = (localStorage.getItem('token') || '').trim();
    if (!token) {
      alert('No has iniciado sesi贸n. Ser谩s redirigido al login.');
      window.location.href = '../index.html';
    }

    const images = [
      '../assets/img/img1.jpg',
      '../assets/img/img2.jpg',
      '../assets/img/img3.jpg',
      '../assets/img/img4.jpg',
      '../assets/img/img5.jpg',
      '../assets/img/img6.jpg',
      '../assets/img/img7.jpg',
      '../assets/img/img8.jpg',
    ];

    const randomImageSrc = images[Math.floor(Math.random() * images.length)];
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.src = randomImageSrc;

    img.onload = () => {
      const container = document.getElementById('puzzle');
      container.innerHTML = '';

      const puzzle = new headbreaker.Canvas('puzzle', {
        width: 600,
        height: 600,
        pieceSize: 60,
        image: img,
        strokeWidth: 2.5,
        strokeColor: '#F0F0F0',
        outline: new headbreaker.outline.Rounded()
      });

      puzzle.adjustImagesToPuzzleWidth();

      puzzle.autogenerate({
        horizontalPiecesCount: 6,
        verticalPiecesCount: 6,
        insertsGenerator: headbreaker.generators.random
      });

      puzzle.shuffle();
      puzzle.shuffleGrid();

      const canvas = document.querySelector('#puzzle canvas');
      const ctx = canvas.getContext('2d');

      ctx.fillStyle = '#e0e0e0';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      puzzle.draw();
      puzzle.registerKeyboardGestures();

      // Actualiza la puntuaci贸n en pantalla
      const scoreDiv = document.getElementById('score');

      function getScore() {
        // 2000 puntos si el puzzle est谩 resuelto, sino 0
        return (puzzle.isSolved && puzzle.isSolved()) ? 2000 : 0;
      }

      async function saveScore() {
        const points = getScore();
        if (points > 0) {
          try {
            await saveGameSession(token, 'RompeCabezas', points);
            console.log(`Puntos guardados: ${points}`);
          } catch (e) {
            alert('Error guardando puntuaci贸n: ' + e.message);
            if (e.message.toLowerCase().includes('unauthorized')) {
              localStorage.clear();
              window.location.href = '../index.html';
            }
          }
        }
      }

      // Funci贸n para comprobar si est谩 resuelto peri贸dicamente
      function checkSolved() {
        if (puzzle.isSolved && puzzle.isSolved()) {
          alert(' 隆Puzzle completado!');
          scoreDiv.textContent = `Puntuaci贸n: ${getScore()}`;
          saveScore();
        } else {
          // Actualiza la puntuaci贸n mostrada aunque no est茅 resuelto (por si quieres hacer m谩s avanzado)
          scoreDiv.textContent = `Puntuaci贸n: ${getScore()}`;
          setTimeout(checkSolved, 1000);
        }
      }

      checkSolved();
    };
  </script>
</body>
</html>

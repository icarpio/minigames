<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mis sesiones de juego</title>
  <link rel="icon" href="/assets/img/favicon.png" type="image/png" />
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    html, body {
      height: 100%;
      margin: 0;
    }
    body {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background-color: #f8f9fa;
    }
    .content-wrapper {
      width: 100%;
      max-width: 700px;
    }

    @media (max-width: 576px) {
      h1 {
        font-size: 1.5rem;
        text-align: center;
      }
      #pagination .btn {
        width: 100%;
        margin-bottom: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="content-wrapper text-center">
    <h1 class="mb-4">Sesiones de Juego</h1>

    <div id="loading" class="d-flex justify-content-center my-4">
    <div class="spinner-border text-primary" role="status" aria-label="Cargando sesiones...">
      <span class="visually-hidden">Cargando...</span>
    </div>
  </div>
    <div id="no-sessions">No has jugado ninguna sesión aún.</div>

    <div class="table-responsive d-none" id="table-container">
      <table id="sessions-table" class="table table-striped table-bordered table-hover text-center">
        <thead class="table-light">
          <tr>
            <th>Juego</th>
            <th>Puntaje</th>
            <th>Fecha</th>
          </tr>
        </thead>
        <tbody id="sessions-body"></tbody>
      </table>
    </div>

    <div id="pagination" class="mt-4 d-none row justify-content-center g-2">
      <div class="col-12 col-sm-auto">
        <button id="prev-btn" class="btn btn-secondary w-100" disabled>Anterior</button>
      </div>
      <div class="col-12 col-sm-auto">
        <button id="next-btn" class="btn btn-secondary w-100" disabled>Siguiente</button>
      </div>
      <div class="col-12 col-sm-auto">
        <button id="home-btn" class="btn btn-primary w-100">Menú</button>
      </div>
    </div>

  <script>
    const token = localStorage.getItem('token');
    if (!token) {
      alert('No estás autenticado. Por favor inicia sesión.');
      window.location.href = 'home.html';
    }

    let nextPageUrl = null;
    let prevPageUrl = null;

    const loadingDiv = document.getElementById('loading');
    const noSessionsDiv = document.getElementById('no-sessions');
    const tableContainer = document.getElementById('table-container');
    const tbody = document.getElementById('sessions-body');
    const paginationDiv = document.getElementById('pagination');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const homeBtn = document.getElementById('home-btn');

    function formatFecha(fechaStr) {
      const fecha = new Date(fechaStr);
      const dia = String(fecha.getDate()).padStart(2, '0');
      const mes = String(fecha.getMonth() + 1).padStart(2, '0');
      const anio = fecha.getFullYear();
      const horas = String(fecha.getHours()).padStart(2, '0');
      const minutos = String(fecha.getMinutes()).padStart(2, '0');
      return `${dia}/${mes}/${anio} ${horas}:${minutos}`;
    }

    function fetchSessions(url) {
      loadingDiv.classList.remove('d-none');
      noSessionsDiv.classList.add('d-none');
      tableContainer.classList.add('d-none');
      paginationDiv.classList.add('d-none');

      fetch(url, {
        headers: {
          'Authorization': 'Token ' + token
        }
      })
      .then(response => {
        if (!response.ok) throw new Error('Error al cargar sesiones');
        return response.json();
      })
      .then(data => {
        loadingDiv.classList.add('d-none');

        nextPageUrl = data.next;
        prevPageUrl = data.previous;

        if (data.results.length === 0) {
          noSessionsDiv.classList.remove('d-none');
          return;
        }

        tbody.innerHTML = '';
        data.results.forEach(session => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${session.game}</td>
            <td>${session.score}</td>
            <td>${formatFecha(session.played_at)}</td>
          `;
          tbody.appendChild(tr);
        });

        tableContainer.classList.remove('d-none');
        paginationDiv.classList.remove('d-none');
        prevBtn.disabled = !prevPageUrl;
        nextBtn.disabled = !nextPageUrl;
      })
      .catch(error => {
        loadingDiv.textContent = 'No se pudieron cargar las sesiones.';
        console.error(error);
      });
    }

    prevBtn.addEventListener('click', () => {
      if (prevPageUrl) fetchSessions(prevPageUrl);
    });

    nextBtn.addEventListener('click', () => {
      if (nextPageUrl) fetchSessions(nextPageUrl);
    });

    homeBtn.addEventListener('click', () => {
      window.location.href = '/home.html';
    });

    fetchSessions('https://albertaapi.onrender.com/api/minigames/sessions/?page=1&page_size=10');
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
